<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Clima Pelotillehue</title>
    
    <!-- PWA Meta Tags para iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Clima Condorito">
    <meta name="theme-color" content="#FFD700">
    <link rel="apple-touch-icon" href="clima.png">
    <link rel="icon" type="image/png" href="clima.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes tipo Cómic -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Iconos -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Comic Neue', cursive;
            background-color: #f0f0f0;
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 20px 20px;
            overscroll-behavior-y: none; /* Previene rebote en iOS */
        }
        
        .font-comic-header {
            font-family: 'Bangers', cursive;
            letter-spacing: 1px;
        }

        .comic-border {
            border: 3px solid black;
            box-shadow: 5px 5px 0px rgba(0,0,0,1);
        }

        .comic-panel {
            background: white;
            border: 3px solid black;
            position: relative;
            overflow: hidden;
        }

        /* Burbuja de diálogo */
        .speech-bubble {
            position: relative;
            background: #fff;
            border: 3px solid #000;
            border-radius: .4em;
        }
        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            width: 0;
            height: 0;
            border: 20px solid transparent;
            border-top-color: #000;
            border-bottom: 0;
            border-left: 0;
            margin-left: -10px;
            margin-bottom: -20px;
        }

        .plop-anim {
            animation: plop 0.5s ease-out;
        }

        @keyframes plop {
            0% { transform: scale(0) rotate(-180deg); }
            80% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        /* Estilo papel periódico viejo */
        .hocicon-paper {
            background-color: #fdfbf7;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col items-center justify-start pt-safe">

    <!-- Header Diario El Hocicón -->
    <header class="w-full max-w-md bg-yellow-400 border-b-4 border-black p-2 text-center shadow-lg z-10">
        <div class="flex justify-between items-center border-b-2 border-black pb-1 mb-1">
            <span class="text-xs font-bold uppercase">Fundado por Yayita</span>
            <span class="text-xs font-bold uppercase">Precio: ¡Un ojo de la cara!</span>
        </div>
        <h1 class="font-comic-header text-5xl text-red-600 drop-shadow-md transform -rotate-1">EL HOCICÓN</h1>
        <p class="font-bold text-sm uppercase tracking-widest">"Pobre pero honrado"</p>
        <div class="mt-1 text-xs font-bold bg-black text-white inline-block px-2 py-0.5 rounded transform rotate-1">
            EDICIÓN ESPECIAL: EL CLIMA
        </div>
    </header>

    <!-- Contenido Principal (Estilo Página de Cómic) -->
    <main class="flex-1 w-full max-w-md p-2 overflow-y-auto pb-20 space-y-3 hocicon-paper">
        
        <!-- Panel 1: Ubicación y Fecha -->
        <div class="comic-panel p-3 flex justify-between items-center bg-blue-100">
            <div>
                <h2 class="font-comic-header text-2xl text-black" id="location-name">Pelotillehue</h2>
                <p class="text-sm font-bold" id="current-date">Cargando fecha...</p>
            </div>
            <div class="bg-yellow-300 border-2 border-black p-2 rounded-full">
                <i data-lucide="map-pin" class="w-6 h-6 text-black"></i>
            </div>
        </div>

        <!-- Panel 2: El Clima Principal (Condorito) -->
        <div class="comic-panel h-64 flex flex-col items-center justify-center bg-white relative">
            <!-- Burbuja de dialogo -->
            <div class="speech-bubble p-4 mb-4 w-11/12 text-center shadow-lg z-10 absolute top-2">
                <p class="text-lg font-bold uppercase italic" id="condorito-phrase">
                    "¡Recorcholis! Déjame ver cómo está el tiempo..."
                </p>
            </div>

            <!-- Visualización del Clima -->
            <div class="mt-20 flex items-center justify-center space-x-4 z-0">
                <div id="weather-icon-container" class="transform scale-150 text-black">
                    <i data-lucide="loader" class="animate-spin w-12 h-12"></i>
                </div>
                <div class="text-center">
                    <span id="temp-current" class="font-comic-header text-6xl block leading-none">--°</span>
                    <span id="weather-desc" class="text-sm font-bold bg-black text-white px-2 py-1 transform -rotate-2 inline-block mt-1">
                        Consultando...
                    </span>
                </div>
            </div>

            <!-- Decoración "Plop!" (Oculta por defecto) -->
            <div id="plop-text" class="hidden absolute bottom-2 right-2 font-comic-header text-4xl text-red-600 transform -rotate-12 z-20">
                ¡PLOP!
            </div>
        </div>

        <!-- Tira Cómica de Detalles (Grid) -->
        <div class="grid grid-cols-2 gap-3">
            
            <!-- Panel 3: Pepe Cortisona (Máxima/Mínima) -->
            <div class="comic-panel p-2 bg-red-50 flex flex-col items-center">
                <div class="w-full border-b-2 border-black mb-1 text-center bg-red-200">
                    <span class="font-bold text-xs uppercase">Saco de Plomo Informa</span>
                </div>
                <div class="flex justify-around w-full mt-2">
                    <div class="text-center">
                        <i data-lucide="arrow-up" class="w-5 h-5 mx-auto text-red-500"></i>
                        <span class="font-bold text-xl" id="temp-max">--°</span>
                        <div class="text-xs">Máx</div>
                    </div>
                    <div class="w-0.5 h-10 bg-black"></div>
                    <div class="text-center">
                        <i data-lucide="arrow-down" class="w-5 h-5 mx-auto text-blue-500"></i>
                        <span class="font-bold text-xl" id="temp-min">--°</span>
                        <div class="text-xs">Mín</div>
                    </div>
                </div>
            </div>

            <!-- Panel 4: Coné (Viento/Lluvia) -->
            <div class="comic-panel p-2 bg-green-50 flex flex-col items-center">
                 <div class="w-full border-b-2 border-black mb-1 text-center bg-green-200">
                    <span class="font-bold text-xs uppercase">Detalles de Coné</span>
                </div>
                <div class="grid grid-cols-2 gap-2 w-full mt-1 text-xs font-bold">
                    <div class="flex items-center">
                        <i data-lucide="wind" class="w-3 h-3 mr-1"></i>
                        <span id="wind-speed">-- km/h</span>
                    </div>
                    <div class="flex items-center">
                        <i data-lucide="droplets" class="w-3 h-3 mr-1"></i>
                        <span id="humidity">--%</span>
                    </div>
                    <div class="col-span-2 text-center mt-1 border-t border-black pt-1 italic text-gray-600" id="rain-chance">
                        Prob. Lluvia: --%
                    </div>
                </div>
            </div>
        </div>

        <!-- Botón de Actualizar -->
        <button onclick="fetchWeather()" class="w-full bg-black text-yellow-400 font-comic-header text-2xl py-3 border-4 border-yellow-400 shadow-lg active:transform active:scale-95 transition-transform mb-6">
            ¡ACTUALIZAR, ROTO!
        </button>

    </main>

    <!-- PWA Manifest Generation (Inline) -->
    <script>
        // Generar Manifiesto dinámicamente para que sea un solo archivo
        const manifest = {
            "name": "Clima Hocicón",
            "short_name": "Clima",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f0f0f0",
            "theme_color": "#FFD700",
            "icons": [
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/826/826955.png", // Icono genérico de sol tipo cómic
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/826/826955.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
    </script>

    <!-- Lógica de la App -->
    <script>
        // Inicializar iconos
        lucide.createIcons();

        // Elementos DOM
        const els = {
            loc: document.getElementById('location-name'),
            date: document.getElementById('current-date'),
            phrase: document.getElementById('condorito-phrase'),
            tempCurrent: document.getElementById('temp-current'),
            weatherDesc: document.getElementById('weather-desc'),
            tempMax: document.getElementById('temp-max'),
            tempMin: document.getElementById('temp-min'),
            wind: document.getElementById('wind-speed'),
            humidity: document.getElementById('humidity'),
            rain: document.getElementById('rain-chance'),
            iconContainer: document.getElementById('weather-icon-container'),
            plop: document.getElementById('plop-text')
        };

        // Frases estilo Condorito según código WMO
        const phrases = {
            0: "¡Reflauta! El cielo está más limpio que mi billetera.", // Despejado
            1: "¡Tome Pin y haga Pun! Un día agradable compadre.", // Mayormente despejado
            2: "Se está nublando, igual que el juicio de Pepe Cortisona.", // Nublado
            3: "¡Está más tapado que oreja de sordo! (Nublado)", // Cubierto
            45: "No se ve ni una cuestión con esta niebla.", // Niebla
            48: "Niebla con escarcha... ¡Qué frío, por la mugre!",
            51: "Está chispeando... apenas.", // Llovizna
            61: "¡Exijo una explicación! Se largó a llover suave.", // Lluvia leve
            63: "¡Afírmate Cabrito! Llueve moderado.", // Lluvia moderada
            65: "¡Recorcholis! Está lloviendo a cántaros.", // Lluvia fuerte
            80: "¡Arranca Washington! Se vienen chaparrones.", // Lluvia intensa
            95: "¡Santa Bárbara bendita! Tormenta eléctrica.", // Tormenta
            96: "¡Ay caramba! Granizo... a esconderse al bar.", // Granizo
        };

        function getCondoritoPhrase(code, temp) {
            // Overrides por temperatura extrema
            if (temp > 30) return "¡Me aso, compadre! ¡Tráiganme una Bilz!";
            if (temp < 5) return "¡Estoy tiritando como canasto de guatitas!";
            
            return phrases[code] || phrases[code] || "El tiempo está loco, igual que el Roto Quezada.";
        }

        function getWeatherIcon(code) {
            // Mapeo simple de códigos WMO a iconos Lucide
            if (code === 0) return 'sun';
            if (code >= 1 && code <= 3) return 'cloud-sun';
            if (code >= 45 && code <= 48) return 'cloud-fog';
            if (code >= 51 && code <= 67) return 'cloud-rain';
            if (code >= 71 && code <= 77) return 'snowflake';
            if (code >= 80 && code <= 82) return 'cloud-drizzle';
            if (code >= 95) return 'cloud-lightning';
            return 'help-circle';
        }

        function updateDate() {
            const now = new Date();
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            els.date.textContent = now.toLocaleDateString('es-CL', options);
        }

        async function fetchWeather() {
            els.weatherDesc.textContent = "Buscando satélite...";
            els.plop.classList.add('hidden');
            
            if (!navigator.geolocation) {
                alert("¡Plop! Tu dispositivo no tiene GPS.");
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                // Actualizar nombre de ubicación (mock o reverse geo simple si fuera necesario, usaremos Pelotillehue/Coord por ahora)
                // Para mantenerlo simple y sin keys, usamos el nombre de la zona horaria o "Tu Ubicación"
                
                try {
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max&hourly=relativehumidity_2m,surface_pressure&timezone=auto`);
                    const data = await response.json();

                    if(data.error) throw new Error("Error API");

                    const current = data.current_weather;
                    const daily = data.daily;
                    
                    // Actualizar UI
                    els.tempCurrent.textContent = `${Math.round(current.temperature)}°`;
                    els.tempMax.textContent = `${Math.round(daily.temperature_2m_max[0])}°`;
                    els.tempMin.textContent = `${Math.round(daily.temperature_2m_min[0])}°`;
                    els.wind.textContent = `${current.windspeed} km/h`;
                    
                    // Humedad (tomamos la hora actual aproximada)
                    const hourIndex = new Date().getHours();
                    const humidity = data.hourly.relativehumidity_2m[hourIndex] || "--";
                    els.humidity.textContent = `${humidity}% Hum.`;
                    
                    // Probabilidad lluvia hoy
                    els.rain.textContent = `Prob. Lluvia: ${daily.precipitation_probability_max[0]}%`;

                    // Icono y Descripción
                    const wmoCode = current.weathercode;
                    const iconName = getWeatherIcon(wmoCode);
                    els.iconContainer.innerHTML = `<i data-lucide="${iconName}" class="w-24 h-24 text-black drop-shadow-md"></i>`;
                    lucide.createIcons();
                    
                    els.weatherDesc.textContent = "Reporte Actualizado";
                    
                    // Frase de Condorito
                    els.phrase.textContent = `"${getCondoritoPhrase(wmoCode, current.temperature)}"`;

                    // Nombre de ubicación (Obtenido de timezone simplificado)
                    const zone = data.timezone.split('/')[1] || "Pelotillehue";
                    els.loc.textContent = zone.replace('_', ' ');

                } catch (error) {
                    els.phrase.textContent = "¡Exijo una explicación! No pude ver el clima.";
                    els.plop.classList.remove('hidden');
                    console.error(error);
                }

            }, (error) => {
                els.phrase.textContent = "¡Plop! Activa el GPS, pajarraco.";
                els.plop.classList.remove('hidden');
            });
        }

        // Iniciar
        updateDate();
        fetchWeather();

        // Service Worker ficticio para criterios de PWA instalable
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>

</html>
